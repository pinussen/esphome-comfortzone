esphome:
  platformio_options:
    build_flags:
      - "-O3"
      - "-DHP_PROTOCOL=${comfortzone_protocol_version}"

external_components:
  - source:
      type: git
      url: https://github.com/pinussen/esphome-comfortzone
      ref: ${git_branch}
    components: [ comfortzone ]

# Tracks the current offset of the indoor temperature sensor
globals:
  - id: te3_offset
    type: float
    restore_value: yes
    initial_value: '0.0'

uart:
  id: uart_bus
  tx_pin: ${tx_pin}
  rx_pin: ${rx_pin}
  baud_rate: 19200
  data_bits: 8
  parity: NONE
  stop_bits: 1

comfortzone:
  re_de_pin: ${re_de_pin}
  te3_offset_global_id: te3_offset

sensor:
  - platform: comfortzone
    ${device_name}fan_time_to_filter_change:
      name: "Days until filter change"
    ${device_name}te0_outdoor_temp:
      name: "Outdoor temperature"
    ${device_name}te1_flow_water:
      name: "Flow water temperature"
    ${device_name}te2_return_water:
      name: "Return water temperature"
    ${device_name}te3_indoor_temp:
      name: "Indoor temperature"
    ${device_name}te4_hot_gas_temp:
      name: "Hot gas temperature"
    ${device_name}te5_exchanger_out:
      name: "Exchanger out temperature"
    ${device_name}te6_evaporator_in:
      name: "Evaporator in temperature"
    ${device_name}te7_exhaust_air:
      name: "Exhaust air temperature"
    ${device_name}te24_hot_water_temp:
      name: "Hot water temperature"
    ${device_name}expansion_valve_calculated_setting:
      name: "Expansion valve calculated setting"
    ${device_name}expansion_valve_temperature_difference:
      name: "Expansion valve temperature difference"
    ${device_name}current_compressor_frequency:
      name: "Current compressor frequency"
    ${device_name}current_compressor_power:
      name: "Current compressor power"
    ${device_name}current_compressor_additional_power:
      name: "Current compressor additional power"
    ${device_name}current_compressor_total_power:
      name: "Current compressor total power"
    ${device_name}current_compressor_input_power:
      name: "Current compressor input power"
      id: current_compressor_input_power
    ${device_name}current_compressor_heating_input_power:
      name: "Current compressor heating input power"
      id: current_compressor_heating_input_power
    ${device_name}current_compressor_water_input_power:
      name: "Current compressor water input power"
      id: current_compressor_water_input_power
    ${device_name}compressor_energy:
      name: "Compressor energy"
    ${device_name}add_energy:
      name: "Additional energy"
    ${device_name}hot_water_energy:
      name: "Hot water energy"
    ${device_name}compressor_runtime:
      name: "Compressor runtime"
    ${device_name}total_runtime:
      name: "Total runtime"
    ${device_name}room_heating_setting:
      name: "Room heating setting"
    ${device_name}hot_water_setting:
      name: "Hot water setting"
    ${device_name}fan_speed_duty:
      name: "Fan speed duty"
    ${device_name}hot_water_calculated_setting:
      name: "Hot water calculated setting"
    ${device_name}heating_cop:
      name: "Heating CoP"
    ${device_name}water_cop:
      name: "Hot Water CoP"
    ${device_name}te3_indoor_temp_offset:
      name: "Indoor temperature sensor offset"
    ${device_name}target_flow_water_temperature:
      name: "Target flow water temperature"
  - platform: ${device_name}total_daily_energy
    name: "Total Daily Input Energy"
    power_id: current_compressor_input_power
  - platform: ${device_name}total_daily_energy
    name: "Total Daily Heating Input Energy"
    power_id: current_compressor_heating_input_power
  - platform: ${device_name}total_daily_energy
    name: "Total Daily Water Input Energy"
    power_id: ${device_name}current_compressor_water_input_power

binary_sensor:
  - platform: comfortzone
    ${device_name}filter_alarm:
      name: "Filter alarm"
    ${device_name}hot_water_production:
      name: "Hot water production"
    ${device_name}room_heating_in_progress:
      name: "Room heating in progress"
    ${device_name}additional_power_enabled:
      name: "Additional power enabled"
    ${device_name}defrost_enabled:
      name: "Defrost enabled"
    ${device_name}extra_hot_water_setting:
      name: "Extra hot water setting"

text_sensor:
  - platform: comfortzone
    ${device_name}compressor_activity:
      name: "Compressor activity"
    ${device_name}mode:
      name: "Mode"
    ${device_name}fan_speed:
      name: "Fan speed"
    ${device_name}hot_water_priority_setting:
      name: "Hot water priority setting"

climate:
  - platform: comfortzone
    ${device_name}heatpump_climate:
      name: "ComfortZone EX50 heating"
    ${device_name}water_heater_climate:
      name: "ComfortZone EX50 hot water"
      visual:
        min_temperature: 30
        max_temperature: 65

# Needed to keep track of sensor offset changes
time:
  - platform: sntp
    id: sntp_time

# Enable Home Assistant API
api:
  encryption:
    key: ${api_key}